<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPT-5 PRO ¬∑ –í–µ–±-—á–∞—Ç</title>
  <meta name="theme-color" content="#0f1115" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1115;--card:#151922;--text:#e8eefc;--muted:#a8b0c2;--accent:#3ef07d;--stroke:#272c36;--radius:16px;--max:900px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui;line-height:1.55;color:var(--text);background:var(--bg)}
    a{color:inherit}
    header{max-width:var(--max);margin:0 auto;padding:18px 14px 0;display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:50%;background:#fff center/70% no-repeat;
      box-shadow:0 0 0 1px var(--stroke) inset;background-image:url('logo_circle_black_on_white.png')}
    .title{font-weight:700}
    .wrap{max-width:var(--max);margin:0 auto;padding:14px}
    .topBtns{display:flex;gap:8px;margin:8px 0 12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;text-decoration:none;border:1px solid var(--stroke);background:#10161f}
    .btn-ghost{background:transparent}
    .chat{background:var(--card);border:1px solid var(--stroke);border-radius:var(--radius);height:64vh;min-height:360px;overflow:auto;padding:14px}
    .msg{display:flex;gap:10px;margin:10px 0}
    .msg .b{padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);max-width:85%;white-space:pre-wrap;word-wrap:break-word}
    .me{justify-content:flex-end}
    .me .b{background:#0e1420}
    .bot .b{background:#111722}
    .bubble-head{font-size:12px;color:var(--muted);margin-bottom:6px}
    .img-prev{max-width:220px;border-radius:10px;border:1px solid var(--stroke);display:block;margin-top:8px}
    .tools{display:flex;gap:6px;margin-top:8px}
    .tools button{background:#0d1320;border:1px solid var(--stroke);color:var(--muted);padding:6px 10px;border-radius:10px;font-size:12px}
    .muted{color:var(--muted)}
    .bar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,transparent,rgba(15,17,21,.92) 25%,#0f1115);
      padding:10px 14px 18px}
    .bar .inner{max-width:var(--max);margin:0 auto}
    .row{display:flex;gap:8px}
    input[type=text]{flex:1;background:#0e1420;color:var(--text);border:1px solid var(--stroke);border-radius:12px;padding:12px}
    button.send{background:var(--accent);color:#04110a;border:0;border-radius:12px;font-weight:700;padding:12px 16px;min-width:140px}
    label.up{display:inline-flex;align-items:center;gap:8px;background:#10161f;border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;cursor:pointer}
    #file{display:none}
    .hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .typing{opacity:.8;animation:pulse 1.2s infinite}
    @keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden="true"></div>
    <div>
      <div class="title">GPT-5 PRO ¬∑ –≤–µ–±-—á–∞—Ç</div>
      <div class="muted" style="font-size:13px">–£—á—ë–±–∞, —Ä–∞–±–æ—Ç–∞, –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
    </div>
  </header>

  <div class="wrap">
    <div class="topBtns">
      <a class="btn" href="index.html">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <a class="btn" href="premium.html">üí≥ –¢–∞—Ä–∏—Ñ—ã</a>
      <a class="btn" href="terms.html">üìÑ –£—Å–ª–æ–≤–∏—è</a>
      <a class="btn" id="open-bot" href="#">‚ö° –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a>
      <button class="btn btn-ghost" id="clear">üßπ –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </div>

    <div id="chat" class="chat" aria-live="polite"></div>
  </div>

  <div class="bar">
    <div class="inner">
      <div class="row" style="margin-bottom:8px">
        <label class="up">
          üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          <input id="file" type="file" accept="image/*">
        </label>
        <div id="fileName" class="muted" style="align-self:center"></div>
      </div>
      <div class="row">
        <input id="inp" type="text" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å‚Ä¶ (Ctrl/‚åò+Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)" />
        <button class="send" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="hint">
        –°–æ–≤–µ—Ç—ã: ¬´–°–¥–µ–ª–∞–π –∫–æ–Ω—Å–ø–µ–∫—Ç –≥–ª–∞–≤—ã 3¬ª, ¬´–†–∞–∑–±–µ—Ä–∏ —Ñ–æ—Ç–æ –∏ –≤—ã–ø–∏—à–∏ —Ç–µ–∫—Å—Ç¬ª, ¬´–ù–∞–π–¥–∏ —Å–≤–µ–∂–∏–µ —Ñ–∞–∫—Ç—ã —Å–æ —Å—Å—ã–ª–∫–∞–º–∏¬ª.
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const API = "https://gpt5pro-api.onrender.com";
    const BOT_USERNAME = "progpt5_bot";

    // === –≠–ª–µ–º–µ–Ω—Ç—ã ===
    const chat = document.getElementById('chat');
    const inp  = document.getElementById('inp');
    const btn  = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const fileInput = document.getElementById('file');
    const fileName  = document.getElementById('fileName');
    const openBot   = document.getElementById('open-bot');

    // === –ò—Å—Ç–æ—Ä–∏—è (localStorage) ===
    let history = [];
    try { history = JSON.parse(localStorage.getItem('gpt5pro_chat') || '[]'); } catch(_) { history = []; }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    history.forEach(m => addBubble(m.role, m.content, m.image_url));

    // === –†–µ–Ω–¥–µ—Ä –ø—É–∑—ã—Ä—è ===
    function esc(s){ return String(s).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
    function addBubble(role, text, imageUrl){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'me' : 'bot');
      const head = role === 'user' ? '–í—ã' : 'GPT-5 PRO';
      const img = imageUrl ? `<img class="img-prev" src="${imageUrl}" alt="–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">` : '';
      wrap.innerHTML = `
        <div class="b">
          <div class="bubble-head">${head}</div>
          <div>${esc(text || '')}</div>
          ${img}
          ${role !== 'user' ? `
          <div class="tools">
            <button data-copy="${esc((text || '').replace(/"/g,'&quot;'))}">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>` : ``}
        </div>`;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;

      // –∫–Ω–æ–ø–∫–∞ –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
      wrap.querySelectorAll('[data-copy]').forEach(b=>{
        b.addEventListener('click', ()=> {
          navigator.clipboard.writeText(text || '');
          b.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ ‚úì';
          setTimeout(()=> b.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 1200);
        });
      });
    }

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä ¬´–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶¬ª
    let typingDiv = null;
    function showTyping(){
      typingDiv = document.createElement('div');
      typingDiv.className = 'msg bot';
      typingDiv.innerHTML = `<div class="b typing">–ü–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>`;
      chat.appendChild(typingDiv);
      chat.scrollTop = chat.scrollHeight;
    }
    function hideTyping(){ if (typingDiv){ typingDiv.remove(); typingDiv = null; } }

    // === API ===
    async function callApi(body){
      const r = await fetch(API + "/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      if (!r.ok) throw new Error("API " + r.status);
      return await r.json();
    }

    // === –û—Ç–ø—Ä–∞–≤–∫–∞ ===
    let pendingImageDataUrl = null;

    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0];
      if (!f) { pendingImageDataUrl = null; fileName.textContent = ""; return; }
      if (f.size > 12*1024*1024) { alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>12 –ú–ë)"); fileInput.value=""; return; }
      const fr = new FileReader();
      fr.onload = () => { pendingImageDataUrl = fr.result; fileName.textContent = f.name; };
      fr.readAsDataURL(f);
    });

    async function send(){
      const q = inp.value.trim();
      if (!q && !pendingImageDataUrl) return;

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      addBubble('user', q, pendingImageDataUrl || undefined);
      history.push({role:'user', content:q, image_url: pendingImageDataUrl || null});
      saveHistory();

      // –≥–æ—Ç–æ–≤–∏–º –∑–∞–ø—Ä–æ—Å –∫ API: –ø–µ—Ä–µ–¥–∞–¥–∏–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–∞–∫ messages
      const messages = history
        .filter(m => m.role === 'user' || m.role === 'assistant')
        .map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));

      const payload = { messages };
      if (pendingImageDataUrl) payload.image_url = pendingImageDataUrl;

      // –æ—á–∏—Å—Ç–∏–º –ø–æ–ª–µ
      inp.value = ""; inp.focus(); fileInput.value=""; fileName.textContent="";

      // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      btn.disabled = true;
      showTyping();

      try {
        const data = await callApi(payload);
        hideTyping();
        const answer = data.answer || data.text || "(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)";
        addBubble('assistant', answer);
        history.push({role:'assistant', content:answer});
        saveHistory();
      } catch(err){
        hideTyping();
        addBubble('assistant', "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ API. " + String(err));
      } finally {
        btn.disabled = false;
        pendingImageDataUrl = null;
      }
    }

    function saveHistory(){
      try { localStorage.setItem('gpt5pro_chat', JSON.stringify(history).slice(0, 500000)); } catch(_) {}
    }

    btn.addEventListener('click', send);
    inp.addEventListener('keydown', (e) => {
      // Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å; Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞; Ctrl/‚åò+Enter ‚Äî —Ç–æ–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); send(); }
    });

    clearBtn.addEventListener('click', ()=>{
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ?')) return;
      history = []; saveHistory(); chat.innerHTML = '';
    });

    // –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
    openBot.addEventListener('click', (e)=>{
      e.preventDefault();
      const deep = `tg://resolve?domain=${BOT_USERNAME}&start=from_web_chat`;
      const web  = `https://t.me/${BOT_USERNAME}?start=from_web_chat`;
      try { window.location.href = deep; setTimeout(()=>{ window.location.href = web; }, 600); }
      catch(_){ window.location.href = web; }
    });

    // Mini App —É–ª—É—á—à–∞–ª–∫–∏
    const tg = window.Telegram?.WebApp;
    if (tg) { try{ tg.expand(); tg.ready(); }catch(_){} }
  </script>
</body>
</html>
